!function(r,n){"object"==typeof exports&&"undefined"!=typeof module?module.exports=n():"function"==typeof define&&define.amd?define(n):(r="undefined"!=typeof globalThis?globalThis:r||self).jp3g=n()}(this,(function(){"use strict";var r=new Uint8Array([0,1,8,16,9,2,3,10,17,24,32,25,18,11,4,5,12,19,26,33,40,48,41,34,27,20,13,6,7,14,21,28,35,42,49,56,57,50,43,36,29,22,15,23,30,37,44,51,58,59,52,45,38,31,39,46,53,60,61,54,47,55,62,63]),n="JFIF",t="SOS";function e(){for(var r=0,n=0,t=arguments.length;n<t;n++)r+=arguments[n].length;var e=Array(r),a=0;for(n=0;n<t;n++)for(var o=arguments[n],i=0,u=o.length;i<u;i++,a++)e[a]=o[i];return e}var a,o,i,u,f,c,v="undefined"!=typeof window?0:"undefined"!=typeof self?1:2,l=Array.prototype.slice,h=function(r){return"function"==typeof r},s=function(r,n){return function(){for(var t=[],a=0;a<arguments.length;a++)t[a]=arguments[a];var o=t.length-1,i=p(t,0,o),u=t[o];r.apply(void 0,e(i,[function(r,t){if(r)u(r);else{var e=void 0;e=1===n.length?[u]:[t,u],n.apply(void 0,e)}}]))}},d=function(r){return function(){for(var n,t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];return h(t[t.length-1])||(n=new Promise((function(r,n){t.push((function(t,e){t?n(t):r(e)}))}))),r.apply(void 0,t),n}},p=function(r,n,t){return l.call(r,n,t)},g=function(){try{return new ImageData(1,1),function(r,n,t){return new ImageData(r,n,t)}}catch(r){return 2===v?function(r,n,t){return{data:r,width:n,height:t}}:function(r,n,t){var e=document.createElement("canvas").getContext("2d").createImageData(n,t);return e.data.set(r),e}}}(),y=function(r){var n=[],t=r(),e=function(){for(;n.length>0&&t;){n.shift()()}};return[function(){t=r(),e()},function(r){n.push(r),e()}]},m=[],w=0,b=new Map,E=[],I=function(r){return function(n){var t,e,a,o=n.data,i=o[0],u=o[1],f=o[2],c=m[u],v=c[1],l=c[2];try{e=l(t=v.apply(void 0,f))}catch(r){a=r.message}r([i,a,t],e)}},A=function(r){var n=[r,!0];return r.onmessage=function(r){var t=r.data,e=t[0],a=t[1],o=t[2];n[1]=!0;var i=b.get(e);b.delete(e),i(null!=a?Error(a):void 0,o)},n},k=0,M=[A((i=I((function(r){var n={data:r};o.onmessage(n)})),o={postMessage:function(r){var n={data:r};setTimeout((function(){i(n)}))}}))],T=M,S=function(r,n,t){var e=n[0],a=n[1],o=n[2];b.set(e,t);var i=(0,m[a][0])(o);r.postMessage([e,a,o],i)},U=function(){T===M&&(T=[]);for(var r=k-T.length,n=0;r<0&&n<T.length;n+=1){var t=T[n],a=t[0];t[1]&&(a.terminate(),T.splice(n,1),r+=1,n-=1)}var o=T.reduce((function(r,n){return r+ +n[1]}),0),i=Math.min(r-o,E.length);for(n=0;n<i;n+=1){var f=A(new Worker(u));T.push(f)}0===T.length&&(T=M);for(var c=0,v=T;c<v.length;c++){a=(f=v[c])[0];if(f[1]){var l=E.shift();l&&(f[1]=!1,S.apply(void 0,e([a],l)))}}x()},x=y((function(){return T.some((function(r){return r[1]}))}))[0],D=function(r,n,t){var e=m.length;return m.push([r,n,t]),function(){for(var r=[],n=0;n<arguments.length;n++)r[n]=arguments[n];var t=r.length-1,a=r[t];r=p(r,0,t);var o=[w++,e,r];E.push([o,function(r,n){a(r,n),U()}]),U()}};0===v?(u=(null!==(a=document.currentScript)&&void 0!==a?a:(c=document.getElementsByTagName("script"),c[c.length-1])).src,f=function(r){window.Worker&&k!==r&&(k=r,U())}):1===v&&(onmessage=I(postMessage));var O,C,F=function(r,n){return r[n]<<8|r[n+1]},P=function(r){return[r>>4,15&r]},q=function(r){var n=r.counts,t=r.symbols,e=[],a=t.length;if(n.reduce((function(r,n){return r+n}),0)!==a)throw Error("Invalid huffman table");for(var o=n.length-1;o>=0;o-=1){var i=n[o],u=p(t,a-i,a).concat(e);e=[];for(var f=0;f<u.length;f+=2)e.push(p(u,f,f+2));a-=i}if(e.length>1)throw Error("Invalid huffman table");return e[0]||[]},B=function(r){var n=r.length,t=0,e=[];do{if(n-t<17)throw Error("Invalid segment length");var a=P(r[t++]),o=a[0],i=a[1],u=p(r.subarray(t,t+16));t+=16;var f=u.reduce((function(r,n){return r+n}),0);if(f>n-t)throw Error("Invalid segment length");var c=p(r.subarray(t,t+f));t+=f;var v=q({counts:u,symbols:c});e.push({cls:o,id:i,tree:v})}while(t!==n);return{type:"DHT",tables:e}},z=function(r){return r?F:function(r,n){return r[n]}},N=function(n){var t=[],e=0,a=n.length;do{if(a-e<1)throw Error("invalid segment length");var o=P(n[e++]),i=o[0],u=o[1];if(u<0||u>3)throw Error("invalid quantization table identifier");if(i<0||i>1)throw Error("invalid quantization value size");var f=i+1;if(64*f>a-e)throw Error("invalid segment length");for(var c=new(i?Uint16Array:Uint8Array)(64),v=z(i),l=0;l<64;l+=1)c[r[l]]=v(n,l*f+e);t.push({id:u,values:c}),e+=64*f}while(e!==a);return{type:"DQT",tables:t}},Q=function(r){return String.fromCharCode.apply(null,r)},W=function(r){return 223<r&&r<240},j=(C=(O=n).length,function(r){var n=r.appType,t=r.data;return 0===n&&0===t[C]&&Q(t.subarray(0,C))===O}),H=function(r,n){var t={type:"APP",appType:r,data:n};return j(t)?J(n):t},J=function(r){var t={type:n,version:[r[5],r[6]],units:r[7],density:{x:F(r,8),y:F(r,10)}},e=r[12],a=r[13];return e>0&&a>0&&(t.thumbnail={x:e,y:a,data:r.subarray(14)}),t},L=function(r){return 192<=r&&r<=207&&196!==r&&200!==r&&204!==r},R=function(r,n){var t=n[0],e=F(n,1),a=F(n,3),o=n[5];if(n.length!==3*o+6)throw Error("Invalid segment length");for(var i=6,u=[],f=0;f<o;f+=1){var c=n[i++],v=P(n[i++]),l=v[0],h=v[1],s=n[i++];u.push({id:c,h:l,v:h,qId:s})}return{type:"SOF",frameType:r,precision:t,width:a,height:e,components:u}},G=function(r){var n;if(n=r,255!==(r=2===v&&Buffer.isBuffer(n)?new Uint8Array(n.buffer,n.byteOffset,n.length):n)[0]||216!==r[1])throw Error("Missing SOI marker");var e,a=[{type:"SOI"}],o=2,i=r.length;r:for(var u=o;u<i;u+=1){var f=r[u];if(255!==f){if(u===o)throw Error("Invalid marker");var c=++u;if(218===f){var l=F(r,u);u+=2;for(var h=r[u++],s=[],d=0;d<h;d+=1){var p=r[u++],g=P(r[u++]),y=g[0],m=g[1];s.push({id:p,dcId:y,acId:m})}for(var w=r[u++],b=r[u++],E=P(r[u++]),I=E[0],A=E[1];u<i;u+=1)if(255===(f=r[u])){if(0===(f=r[u+1])||208<=(e=f)&&e<=215)continue;o=u,a.push({type:t,components:s,specStart:w,specEnd:b,ah:I,al:A,data:r.subarray(c+l,o)});continue r}break}if(217===f)return a.push({type:"EOI"}),a;var k=F(r,u);if(k<2)throw Error("Invalid segment length");u=o=c+k;var M=r.subarray(c+2,o);if(219===f)a.push(N(M));else if(196===f)a.push(B(M));else if(254===f)a.push({type:"COM",text:Q(M)});else if(W(f))a.push(H(15&f,M));else{if(!L(f))throw Error("Unknown marker");a.push(R(15&f,M))}}}throw Error("Unexpected end of buffer")},K=1.3870398453221475,V=1.3065629648763766,X=1.1758756024193588,Y=.7856949583871022,Z=.541196100146197,$=.275899379282943,_=Math.SQRT2,rr=function(r,n){for(var t=0,e=0;t<8;t+=1){var a=r[e++],o=r[e++],i=r[e++],u=r[e++],f=r[e++],c=r[e++],v=r[e++],l=r[e++],h=a+f,s=a-f,d=Z*i-V*v,p=V*i+Z*v,g=$*o-K*l,y=X*c-Y*u,m=Y*c+X*u,w=K*o+$*l,b=g+y,E=y-g,I=w-m,A=m+w,k=(E+I)/_,M=(I-E)/_,T=h+p,S=s+d,U=s-d,x=h-p;n[t]=T+A,n[t+8]=S+M,n[t+16]=U+k,n[t+24]=x+b,n[t+32]=x-b,n[t+40]=U-k,n[t+48]=S-M,n[t+56]=T-A}},nr=new Int16Array(64),tr=new Float64Array(64),er=new Float64Array(64),ar=function(r,n,t,e){for(var a=0;a<64;a+=1)nr[a]=n[a]*r[a];rr(nr,tr),rr(tr,er);for(a=0;a<64;a+=1)t[e++]=er[a]/8+128},or=function(r,n,t,e){t[e]=n[0]*r[0]/8+128},ir=function(r){return 8===r?or:ar},ur=Math.max,fr=Math.ceil,cr=Math.round,vr=function(r,n){return[new Uint8ClampedArray(r*n*4),r,n]},lr=function(r,n,t,e,a,o,i){for(var u=new Uint32Array(3*r*(e/n)),f=0,c=a.length,v=8/n,l=0;l<t;l+=1)for(var h=0;h<c;h+=1)for(var s=a[h],d=s.h,p=s.v,g=o/d,y=i/p,m=0;m<p;m+=1)for(var w=0;w<d;w+=1)for(var b=0;b<v;b+=1)for(var E=0;E<v;E+=1){for(var I=0;I<y;I+=1)for(var A=0;A<g;A+=1){var k=((l*d+w)*v+E)*g+A;k<r&&(u[(k+((m*v+b)*y+I)*r)*c+h]=f)}f+=1}return u},hr=function(r,n,t){var e,a,o,i=n.length,u=0;return function(){for(var f=0;f<i;)e=r[n[f++]],a=r[n[f++]],o=r[n[f++]],t[u++]=e+1.402*o-179.456,t[u++]=e-.34414*a-.71414*o+135.45984,t[u++]=e+1.772*a-226.816,t[u++]=255}},sr=function(n,t){var e=function(r){var n,t=0,e=-1;return function(){if(e<0&&(n=r[t++],e=7,255===n&&0!==r[t++]))throw Error("Unexpected marker in compressed data");return n>>e--&1}}(n),a=function(r){for(var n=0,t=0;t<r;t+=1)n=(n<<1)+e();return n},o=function(r){for(var n;;){if("number"==typeof(n=r[e()]))return n;if(null==n)throw Error("Unexpected huffman code");r=n}};return function(n,e,i){t[0]=n+function(r){var n=o(r),t=a(n);return dr(t,n)}(e);for(var u=1;u<64;u+=1)t[u]=0;for(u=1;u<64;){var f=o(i),c=15&f,v=(240&f)>>4;if(0!==c){var l=a(c);t[r[u+=v]]=dr(l,c),u+=1}else 15===v?u+=16:0===v&&(u=64)}}},dr=function(r,n){return r<1<<n-1?r+(-1<<n)+1:r},pr=Array.isArray,gr=Math.max,yr=function(r){return function(r,n){for(var t=0,e=r;t<e.length;t++){var a=e[t];if(n(a))return a}}(r,(function(r){return"APP"===r.type||r.type===t})).data.buffer},mr=function(r,n){!function(r){return 2!==v&&r instanceof Blob}(r)?n(null,r):function(r,n){var t=new FileReader;t.onload=function(){n(void 0,t.result)},t.onerror=n,t.readAsArrayBuffer(r)}(r,n)},wr=D((function(r){return r}),(function(r){return G(new Uint8Array(r))}),(function(r){return[yr(r)]})),br=D((function(r){var n=r[0];return[yr(n)]}),(function(r,n){var e,a=(void 0===n?{}:n).downScale,o=void 0===a?1:a,i=[[],[]],u=[],f=function(r){switch(r.type){case"DHT":for(var n=0,a=r.tables;n<a.length;n++){var f=a[n];i[f.cls][f.id]=f.tree}break;case"DQT":for(var c=0,v=r.tables;c<v.length;c++){f=v[c];u[f.id]=f}break;case"SOF":if(r.frameType<0||r.frameType>1||8!==r.precision)throw Error("Not 8-bit sequential");for(var l=[],h=0,s=r.components;h<s.length;h++){l[(T=s[h]).id]=T}e={components:l,width:r.width,height:r.height,imageData:vr(cr(r.width/o),cr(r.height/o))};break;case t:if(!e)throw Error("Missing frame");var d=e.components,p=e.width,g=e.height,y=e.imageData,m=y[0],w=y[1],b=r.components;if(!(b.length>1))throw Error("Not interleaved");for(var E=0,I=0,A=0,k=0,M=b;k<M.length;k++){var T=M[k],S=d[T.id],U=S.h,x=S.v;if(U<1||U>4||x<1||x>4)throw Error("Invalid sampling factor");E=ur(E,U),I=ur(I,x),A+=U*x}for(var D=8*I,O=fr(p/(8*E)),C=fr(g/D),F=i[0],P=i[1],q=new Int16Array(64),B=sr(r.data,q),z=b.length,N=new Int16Array(z),Q=Math.pow(8/o,2),W=new Uint8ClampedArray(O*A*Q),j=ir(o),H=hr(W,lr(w,o,O,D,b.map((function(r){var n=r.id;return d[n]})),E,I),m),J=0;J<C;J+=1){for(var L=0,R=0;R<O;R+=1)for(var G=0;G<z;G+=1){T=b[G];for(var K=d[T.id],V=(U=K.h,x=K.v,K.qId),X=u[V].values,Y=0;Y<x;Y+=1)for(var Z=0;Z<U;Z+=1)B(N[G],F[T.dcId],P[T.acId]),N[G]=q[0],j(X,q,W,L),L+=Q}H()}break;case"EOI":return"break-segmentLoop"}};r:for(var c=0,v=r;c<v.length;c++){switch(f(v[c])){case"break-segmentLoop":break r}}if(!e)throw Error("Missing frame");return e.imageData}),(function(r){return[r[0].buffer]})),Er=0,Ir=y((function(){return Er<gr(k,1)+1})),Ar=Ir[0],kr=Ir[1],Mr=function(r){return function(){for(var n=[],t=0;t<arguments.length;t++)n[t]=arguments[t];Er+=1,Ar();var e=n.length-1,a=n[e];n[e]=function(r,n){Er-=1,Ar(),a(r,n)},r.apply(void 0,n)}},Tr=function(r,n){var t,e,a=function(n){pr(r)?n(null,r):s(mr,wr)(r,n)};return{scale:function(t){return Tr(r,n*t)},toJPEG:d(Mr(a)),toImageData:d(Mr(s(a,s((e={downScale:1/n},function(r,n){br(r,e,n)}),(t=function(r){return g.apply(void 0,r)},function(){for(var r,n,e=[],a=0;a<arguments.length;a++)e[a]=arguments[a];var o=e.length-1;try{n=t.apply(void 0,p(e,0,o))}catch(n){r=n}e[o](r,n)})))))}},Sr=function(r){return Tr(r,1)};return Sr.setWorkerCount=f,Sr.waitIdle=kr,Sr.version="0.0.0",Sr}));
