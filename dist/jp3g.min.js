!function(r,n){"object"==typeof exports&&"undefined"!=typeof module?module.exports=n():"function"==typeof define&&define.amd?define(n):(r="undefined"!=typeof globalThis?globalThis:r||self).jp3g=n()}(this,(function(){"use strict";var r=new Uint8Array([0,1,8,16,9,2,3,10,17,24,32,25,18,11,4,5,12,19,26,33,40,48,41,34,27,20,13,6,7,14,21,28,35,42,49,56,57,50,43,36,29,22,15,23,30,37,44,51,58,59,52,45,38,31,39,46,53,60,61,54,47,55,62,63]),n="SOI",t="EOI",e="COM",a="APP",o="JFIF",u="DHT",i="DQT",f="SOF",c="SOS";function l(){for(var r=0,n=0,t=arguments.length;n<t;n++)r+=arguments[n].length;var e=Array(r),a=0;for(n=0;n<t;n++)for(var o=arguments[n],u=0,i=o.length;u<i;u++,a++)e[a]=o[u];return e}var s,h,v,d,p,g="undefined"!=typeof window?0:"undefined"!=typeof self?1:2,y=Array.prototype.slice,m=function(r){return"function"==typeof r},w=function(r,n){return function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];var a=t.length-1,o=E(t,0,a),u=t[a];r.apply(void 0,l(o,[function(r,t){r?u(r):n(t,u)}]))}},b=function(r){return function(){for(var n,t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];return m(t[t.length-1])||(n=new Promise((function(r,n){t.push((function(t,e){t?n(t):r(e)}))}))),r.apply(void 0,t),n}},E=function(r,n,t){return y.call(r,n,t)},I=function(){try{return new ImageData(1,1),function(r,n,t){return new ImageData(r,n,t)}}catch(r){return 2===g?function(r,n,t){return{data:r,width:n,height:t}}:function(r,n,t){var e=document.createElement("canvas").getContext("2d").createImageData(n,t);return e.data.set(r),e}}}(),A=function(r){var n=[],t=r(),e=function(){for(;n.length>0&&t;){n.shift()()}};return[function(){t=r(),e()},function(r){n.push(r),e()}]},k=function(r,n,t){return new Uint8Array(r.buffer,r.byteOffset+n,(null!=t?t:r.byteLength)-n)},x=[],T=0,M=new Map,S=[],U=function(r){return function(n){var t,e,a,o=n.data,u=o[0],i=o[1],f=o[2],c=x[i],l=c[1],s=c[2];try{e=s(t=l.apply(void 0,f))}catch(r){a=r.message}r([u,a,t],e)}},D=function(r){var n=[r,!0];return r.onmessage=function(r){var t=r.data,e=t[0],a=t[1],o=t[2];n[1]=!0;var u=M.get(e);M.delete(e),u(null!=a?Error(a):void 0,o)},n},O=0,C=[D((v=U((function(r){var n={data:r};h.onmessage(n)})),h={postMessage:function(r){var n={data:r};setTimeout((function(){v(n)}))}}))],F=C,B=function(r,n,t){var e=n[0],a=n[1],o=n[2];M.set(e,t);var u=(0,x[a][0])(o);r.postMessage([e,a,o],u)},q=function(){F===C&&(F=[]);for(var r=O-F.length,n=0;r<0&&n<F.length;n+=1){var t=F[n],e=t[0];t[1]&&(e.terminate(),F.splice(n,1),r+=1,n-=1)}var a=F.reduce((function(r,n){return r+ +n[1]}),0),o=Math.min(r-a,S.length);for(n=0;n<o;n+=1){var u=D(new Worker(d));F.push(u)}0===F.length&&(F=C);for(var i=0,f=F;i<f.length;i++){e=(u=f[i])[0];if(u[1]){var c=S.shift();c&&(u[1]=!1,B.apply(void 0,l([e],c)))}}P()},P=A((function(){return F.some((function(r){return r[1]}))}))[0],L=function(r,n,t){var e=x.length;return x.push([r,n,t]),function(){for(var r=[],n=0;n<arguments.length;n++)r[n]=arguments[n];var t=r.length-1,a=r[t];r=E(r,0,t);var o=[T++,e,r];S.push([o,function(r,n){a(r,n),q()}]),q()}};0===g?d=(null!==(s=document.currentScript)&&void 0!==s?s:(p=document.getElementsByTagName("script"),p[p.length-1])).src:1===g&&(onmessage=U(postMessage));var N,j,z=function(r,n){return r[n]<<8|r[n+1]},R=function(r){return[r>>4,15&r]},W=function(r){var n=r.counts,t=r.symbols,e=[],a=t.length;if(n.reduce((function(r,n){return r+n}),0)!==a)throw Error("Invalid huffman table");for(var o=n.length-1;o>=0;o-=1){var u=n[o],i=E(t,a-u,a).concat(e);e=[];for(var f=0;f<i.length;f+=2)e.push(E(i,f,f+2));a-=u}if(e.length>1)throw Error("Invalid huffman table");return e[0]||[]},J=function(r){var n=r.length,t=0,e=[];do{if(n-t<17)throw Error("Invalid segment length");var a=R(r[t++]),o=a[0],i=a[1],f=E(k(r,t,t+16));t+=16;var c=f.reduce((function(r,n){return r+n}),0);if(c>n-t)throw Error("Invalid segment length");var l=E(k(r,t,t+c));t+=c;var s=W({counts:f,symbols:l});e.push({cls:o,id:i,tree:s})}while(t!==n);return{type:u,tables:e}},Q=function(r){return r?z:function(r,n){return r[n]}},_=function(n){var t=[],e=0,a=n.length;do{if(a-e<1)throw Error("invalid segment length");var o=R(n[e++]),u=o[0],f=o[1];if(f<0||f>3)throw Error("invalid quantization table identifier");if(u<0||u>1)throw Error("invalid quantization value size");var c=u+1;if(64*c>a-e)throw Error("invalid segment length");for(var l=new(u?Uint16Array:Uint8Array)(64),s=Q(u),h=0;h<64;h+=1)l[r[h]]=s(n,h*c+e);t.push({id:f,data:l}),e+=64*c}while(e!==a);return{type:i,tables:t}},H=function(r){return String.fromCharCode.apply(null,r)},Y=function(r){return 223<r&&r<240},G=(j=(N=o).length,function(r){var n=r.appType,t=r.data;return 0===n&&0===t[j]&&H(k(t,0,j))===N}),K=function(r,n){var t={type:a,appType:r,data:n};return G(t)?V(n):t},V=function(r){var n={type:o,version:[r[5],r[6]],units:r[7],density:{x:z(r,8),y:z(r,10)}},t=r[12],e=r[13];return t>0&&e>0&&(n.thumbnail={x:t,y:e,data:k(r,14)}),n},X=function(r){return 192<=r&&r<=207&&196!==r&&200!==r&&204!==r},Z=function(r,n){var t=n[0],e=z(n,1),a=z(n,3),o=n[5];if(n.length!==3*o+6)throw Error("Invalid segment length");for(var u=6,i=[],c=0;c<o;c+=1){var l=n[u++],s=R(n[u++]),h=s[0],v=s[1],d=n[u++];i.push({id:l,h:h,v:v,qId:d})}return{type:f,frameType:r,precision:t,width:a,height:e,components:i}},$=function(r,n,t){return r[n++]=t>>8,r[n++]=255&t,n},rr=function(r,n){return r<<4|n},nr=function(r,n,t){if("number"==typeof r){var e=t[n];null==e&&(e=t[n]=[]),e.push(r)}else null!=r&&(nr(r[0],n+1,t),nr(r[1],n+1,t))},tr=function(r){var n=[],t=[],e=[];nr(r,-1,n);for(var a=0;a<n.length;a+=1){var o=n[a];null==o?t[a]=0:(t[a]=o.length,e.push.apply(e,o))}return{counts:t,symbols:e}},er=function(r){var n=r.length;if(n>16)throw Error("Exceeded maximum code length");for(;n<16;n+=1)r.push(0)},ar=function(r){return null==r?0:"number"==typeof r?1:ar(r[0])+ar(r[1])},or=function(r){return r.tables.reduce((function(r,n){var t=n.tree;return r+ar(t)+17}),4)},ur=function(r){return r.tables.reduce((function(r,n){return r+n.data.byteLength+1}),4)},ir=function(r){return r?$:function(r,n,t){return r[n++]=t,n}},fr=function(r,n,t){for(var e=0;e<r.length;e+=1)t[n++]=r.charCodeAt(e);return n},cr=function(r,n,t){t[n++]=255,t[n++]=224|r.appType;var e=r.data.length;return n=$(t,n,e+2),t.set(r.data,n),n+e},lr=function(r){var n,t;return(null!==(t=null===(n=r.thumbnail)||void 0===n?void 0:n.data.length)&&void 0!==t?t:0)+18},sr=function(r){return 10+3*r.components.length},hr=function(l,s,h){switch(l.type){case n:h[s++]=255,h[s++]=216;break;case o:s=function(r,n,t){var e=new Uint8Array(lr(r)-4),a=r.version,o=r.units,u=r.density,i=r.thumbnail,f=fr("JFIF\0",0,e);return e[f++]=a[0],e[f++]=a[1],e[f++]=o,f=$(e,f,u.x),f=$(e,f,u.y),i?(e[f++]=i.x,e[f++]=i.y,e.set(i.data,f)):$(e,f,0),cr({type:"APP",appType:0,data:e},n,t)}(l,s,h);break;case a:s=cr(l,s,h);break;case e:s=function(r,n,t){t[n++]=255,t[n++]=254;var e=r.text.length;return n=$(t,n,e+2),fr(r.text,n,t)}(l,s,h);break;case i:return function(n,t,e){e[t++]=255,e[t++]=219;var a=ur(n)-2,o=n.tables;t=$(e,t,a);for(var u=0,i=o;u<i.length;u++){var f=i[u],c=f.id,l=f.data,s=l.BYTES_PER_ELEMENT-1;e[t++]=rr(s,c);for(var h=ir(s),v=0;v<64;v+=1)t=h(e,t,l[r[v]])}return t}(l,s,h);case f:return function(r,n,t){t[n++]=255,t[n++]=192|r.frameType,n=$(t,n,sr(r)-2),t[n++]=r.precision,n=$(t,n,r.height),n=$(t,n,r.width),t[n++]=r.components.length;for(var e=0,a=r.components;e<a.length;e++){var o=a[e];t[n++]=o.id,t[n++]=rr(o.h,o.v),t[n++]=o.qId}return n}(l,s,h);case u:return function(r,n,t){t[n++]=255,t[n++]=196,n=$(t,n,or(r)-2);for(var e=0,a=r.tables;e<a.length;e++){var o=a[e],u=o.cls,i=o.id,f=o.tree;t[n++]=rr(u,i);var c=tr(f),l=c.counts,s=c.symbols;er(l),t.set(l,n),n+=16,t.set(s,n),n+=s.length}return n}(l,s,h);case c:return function(r,n,t){t[n++]=255,t[n++]=218;var e=2*r.components.length+6;n=$(t,n,e),t[n++]=r.components.length;for(var a=0,o=r.components;a<o.length;a++){var u=o[a],i=u.id,f=u.dcId,c=u.acId;t[n++]=i,t[n++]=rr(f,c)}return t[n++]=r.specStart,t[n++]=r.specEnd,t[n++]=rr(r.ah,r.al),t.set(r.data,n),n+r.data.length}(l,s,h);case t:h[s++]=255,h[s++]=217}return s},vr=1.3870398453221475,dr=1.3065629648763766,pr=1.1758756024193588,gr=.7856949583871022,yr=.541196100146197,mr=.275899379282943,wr=Math.SQRT2,br=function(r,n){for(var t=0,e=0;t<8;t+=1){var a=r[e++],o=r[e++],u=r[e++],i=r[e++],f=r[e++],c=r[e++],l=r[e++],s=r[e++],h=a+f,v=a-f,d=yr*u-dr*l,p=dr*u+yr*l,g=mr*o-vr*s,y=pr*c-gr*i,m=gr*c+pr*i,w=vr*o+mr*s,b=g+y,E=y-g,I=w-m,A=m+w,k=(E+I)/wr,x=(I-E)/wr,T=h+p,M=v+d,S=v-d,U=h-p;n[t]=T+A,n[t+8]=M+x,n[t+16]=S+k,n[t+24]=U+b,n[t+32]=U-b,n[t+40]=S-k,n[t+48]=M-x,n[t+56]=T-A}},Er=new Int16Array(64),Ir=new Float64Array(64),Ar=new Float64Array(64),kr=function(r,n,t,e){for(var a=0;a<64;a+=1)Er[a]=n[a]*r[a];br(Er,Ir),br(Ir,Ar);for(a=0;a<64;a+=1)t[e++]=Ar[a]/8+128},xr=function(r,n,t,e){t[e]=n[0]*r[0]/8+128},Tr=function(r){return 8===r?xr:kr},Mr=Math.max,Sr=Math.ceil,Ur=Math.round,Dr=function(r,n){return[new Uint8ClampedArray(r*n*4),r,n]},Or=function(r,n,t,e,a,o,u){for(var i=new Uint32Array(3*r*(e/n)),f=0,c=a.length,l=8/n,s=0;s<t;s+=1)for(var h=0;h<c;h+=1)for(var v=a[h],d=v.h,p=v.v,g=o/d,y=u/p,m=0;m<p;m+=1)for(var w=0;w<d;w+=1)for(var b=0;b<l;b+=1)for(var E=0;E<l;E+=1){for(var I=0;I<y;I+=1)for(var A=0;A<g;A+=1){var k=((s*d+w)*l+E)*g+A;k<r&&(i[(k+((m*l+b)*y+I)*r)*c+h]=f)}f+=1}return i},Cr=function(r,n,t){var e,a,o,u=n.length,i=0;return function(){for(var f=0;f<u;)e=r[n[f++]],a=r[n[f++]],o=r[n[f++]],t[i++]=e+1.402*o-179.456,t[i++]=e-.34414*a-.71414*o+135.45984,t[i++]=e+1.772*a-226.816,t[i++]=255}},Fr=function(n,t){var e=function(r){var n,t=0,e=-1;return function(){if(e<0&&(n=r[t++],e=7,255===n&&0!==r[t++]))throw Error("Unexpected marker in compressed data");return n>>e--&1}}(n),a=function(r){for(var n=0,t=0;t<r;t+=1)n=(n<<1)+e();return n},o=function(r){for(var n;;){if("number"==typeof(n=r[e()]))return n;if(null==n)throw Error("Unexpected huffman code");r=n}};return function(n,e,u){t[0]=n+function(r){var n=o(r),t=a(n);return Br(t,n)}(e);for(var i=1;i<64;i+=1)t[i]=0;for(i=1;i<64;){var f=o(u),c=15&f,l=(240&f)>>4;if(0!==c){var s=a(c);t[r[i+=l]]=Br(s,c),i+=1}else 15===l?i+=16:0===l&&(i=64)}}},Br=function(r,n){return r<1<<n-1?r+(-1<<n)+1:r},qr=Array.isArray,Pr=Math.max,Lr=function(r){return r.data.buffer},Nr=function(r){for(var n=[],t=!1,e=0,u=r;e<u.length;e++){var f=u[e];if(f.type===i)for(var c=0,l=f.tables;c<l.length;c++){var s=l[c];n.push(Lr(s))}else t||(f.type===o&&f.thumbnail?(n.push(Lr(f.thumbnail)),t=!0):f.type!==a&&"SOS"!==f.type||(n.push(Lr(f)),t=!0))}return n},jr=function(r,n){!function(r){return"undefined"!=typeof Blob&&r instanceof Blob}(r)?(r instanceof ArrayBuffer&&(r=new Uint8Array(r)),n(null,r)):function(r,n){var t=new FileReader;t.onload=function(){n(void 0,new Uint8Array(t.result))},t.onerror=n,t.readAsArrayBuffer(r)}(r,n)},zr=L((function(r){return[r[0].buffer]}),(function(r){if(255!==r[0]||216!==r[1])throw Error("Missing SOI marker");var a,o=[{type:n}],u=2,i=r.length;r:for(var f=u;f<i;f+=1){var l=r[f];if(255!==l){if(f===u)throw Error("Invalid marker");var s=++f;if(218===l){var h=z(r,f);f+=2;for(var v=r[f++],d=[],p=0;p<v;p+=1){var g=r[f++],y=R(r[f++]),m=y[0],w=y[1];d.push({id:g,dcId:m,acId:w})}for(var b=r[f++],E=r[f++],I=R(r[f++]),A=I[0],x=I[1];f<i;f+=1)if(255===(l=r[f])){if(0===(l=r[f+1])||208<=(a=l)&&a<=215)continue;u=f,o.push({type:c,components:d,specStart:b,specEnd:E,ah:A,al:x,data:k(r,s+h,u)});continue r}break}if(217===l)return o.push({type:t}),o;var T=z(r,f);if(T<2)throw Error("Invalid segment length");f=u=s+T;var M=k(r,s+2,u);if(219===l)o.push(_(M));else if(196===l)o.push(J(M));else if(254===l)o.push({type:e,text:H(M)});else if(Y(l))o.push(K(15&l,M));else{if(!X(l))throw Error("Unknown marker");o.push(Z(15&l,M))}}}throw Error("Unexpected end of buffer")}),Nr),Rr=L((function(r){var n=r[0];return Nr(n)}),(function(r){for(var l=function(r){return new Uint8Array(r)}(r.reduce((function(r,l){return r+function(r){switch(r.type){case n:case t:return 2;case a:return r.data.length+4;case o:return lr(r);case e:return r.text.length+4;case i:return ur(r);case f:return sr(r);case u:return or(r);case c:return 2*(l=r).components.length+8+l.data.length}var l}(l)}),0)),s=0,h=0,v=r;h<v.length;h++){var d=v[h];s=hr(d,s,l)}return l}),(function(r){return[r.buffer]})),Wr=L((function(r){var n=r[0];return Nr(n)}),(function(r,n){var e,a=(void 0===n?{}:n).downScale,o=void 0===a?1:a,l=[[],[]],s=[],h=function(r){switch(r.type){case u:for(var n=0,a=r.tables;n<a.length;n++){var h=a[n];l[h.cls][h.id]=h.tree}break;case i:for(var v=0,d=r.tables;v<d.length;v++){h=d[v];s[h.id]=h}break;case f:if(r.frameType<0||r.frameType>1||8!==r.precision)throw Error("Not 8-bit sequential");for(var p=[],g=0,y=r.components;g<y.length;g++){p[(D=y[g]).id]=D}e={components:p,width:r.width,height:r.height,imageData:Dr(Ur(r.width/o),Ur(r.height/o))};break;case c:if(!e)throw Error("Missing frame");var m=e.components,w=e.width,b=e.height,E=e.imageData,I=E[0],A=E[1],k=r.components;if(!(k.length>1))throw Error("Not interleaved");for(var x=0,T=0,M=0,S=0,U=k;S<U.length;S++){var D=U[S],O=m[D.id],C=O.h,F=O.v;if(C<1||C>4||F<1||F>4)throw Error("Invalid sampling factor");x=Mr(x,C),T=Mr(T,F),M+=C*F}for(var B=8*T,q=Sr(w/(8*x)),P=Sr(b/B),L=l[0],N=l[1],j=new Int16Array(64),z=Fr(r.data,j),R=k.length,W=new Int16Array(R),J=Math.pow(8/o,2),Q=new Uint8ClampedArray(q*M*J),_=Tr(o),H=Cr(Q,Or(A,o,q,B,k.map((function(r){var n=r.id;return m[n]})),x,T),I),Y=0;Y<P;Y+=1){for(var G=0,K=0;K<q;K+=1)for(var V=0;V<R;V+=1){D=k[V];for(var X=m[D.id],Z=(C=X.h,F=X.v,X.qId),$=s[Z].data,rr=0;rr<F;rr+=1)for(var nr=0;nr<C;nr+=1)z(W[V],L[D.dcId],N[D.acId]),W[V]=j[0],_($,j,Q,G),G+=J}H()}break;case t:return"break-segmentLoop"}};r:for(var v=0,d=r;v<d.length;v++){switch(h(d[v])){case"break-segmentLoop":break r}}if(!e)throw Error("Missing frame");return e.imageData}),(function(r){return[r[0].buffer]})),Jr=0,Qr=A((function(){return Jr<Pr(O,1)+1})),_r=Qr[0],Hr=Qr[1],Yr=function(r){return function(){for(var n=[],t=0;t<arguments.length;t++)n[t]=arguments[t];Jr+=1,_r();var e=n.length-1,a=n[e];n[e]=function(r,n){Jr-=1,_r(),a(r,n)},r.apply(void 0,n)}},Gr=function(r,n){var t,e,a=function(n){qr(r)?n(null,r):w(jr,zr)(r,n)};return{scale:function(t){return Gr(r,n*t)},toObject:b(Yr(a)),toBuffer:b(Yr((function(n){qr(r)?Rr(r,n):jr(r,n)}))),toImageData:b(Yr(w(a,w((e={downScale:1/n},function(r,n){Wr(r,e,n)}),(t=function(r){return I.apply(void 0,r)},function(){for(var r,n,e=[],a=0;a<arguments.length;a++)e[a]=arguments[a];var o=e.length-1;try{n=t.apply(void 0,E(e,0,o))}catch(n){r=n}e[o](r,n)})))))}},Kr=function(r){return Gr(r,1)};return Kr.setWorkerCount=function(r){window.Worker&&O!==r&&(O=r,q())},Kr.waitIdle=Hr,Kr.version="0.0.0",Kr}));
