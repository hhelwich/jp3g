!function(n,r){"object"==typeof exports&&"undefined"!=typeof module?module.exports=r():"function"==typeof define&&define.amd?define(r):(n="undefined"!=typeof globalThis?globalThis:n||self).jp3g=r()}(this,(function(){"use strict";var n=new Uint8Array([0,1,8,16,9,2,3,10,17,24,32,25,18,11,4,5,12,19,26,33,40,48,41,34,27,20,13,6,7,14,21,28,35,42,49,56,57,50,43,36,29,22,15,23,30,37,44,51,58,59,52,45,38,31,39,46,53,60,61,54,47,55,62,63]),r="JFIF",t="SOS",e=function(n,r){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(n,r){n.__proto__=r}||function(n,r){for(var t in r)Object.prototype.hasOwnProperty.call(r,t)&&(n[t]=r[t])})(n,r)};function o(){for(var n=0,r=0,t=arguments.length;r<t;r++)n+=arguments[r].length;var e=Array(n),o=0;for(r=0;r<t;r++)for(var a=arguments[r],i=0,u=a.length;i<u;i++,o++)e[o]=a[i];return e}var a,i,u,f,c,l,v="undefined"!=typeof window?0:"undefined"!=typeof self?1:2,s=Array.prototype.slice,h=function(n){return"function"==typeof n},p=function(n,r){return function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];var a=t.length-1,i=g(t,0,a),u=t[a];n.apply(void 0,o(i,[function(n,t){if(n)u(n);else{var e=void 0;e=1===r.length?[u]:[t,u],r.apply(void 0,e)}}]))}},d=function(n){return function(){for(var r,t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];return h(t[t.length-1])||(r=new Promise((function(n,r){t.push((function(t,e){t?r(t):n(e)}))}))),n.apply(void 0,t),r}},g=function(n,r,t){return s.call(n,r,t)},y=function(){try{return new ImageData(1,1),function(n,r,t){return new ImageData(n,r,t)}}catch(n){return 2===v?function(n,r,t){return{data:n,width:r,height:t}}:function(n,r,t){var e=document.createElement("canvas").getContext("2d").createImageData(r,t);return e.data.set(n),e}}}(),w=function(n){var r=[],t=n(),e=function(){for(;r.length>0&&t;){r.shift()()}};return[function(){t=n(),e()},function(n){r.push(n),e()}]},m=[],b=0,I=new Map,A=[],k=function(n){return function(r){var t,e,o,a=r.data,i=a[0],u=a[1],f=a[2],c=m[u],l=c[1],v=c[2];try{e=v(t=l.apply(void 0,f))}catch(n){o=n.message}n([i,o,t],e)}},E=function(n){var r=[n,!0];return n.onmessage=function(n){var t=n.data,e=t[0],o=t[1],a=t[2];r[1]=!0;var i=I.get(e);I.delete(e),i(null!=o?Error(o):void 0,a)},r},O=0,M=[E((u=k((function(n){var r={data:n};i.onmessage(r)})),i={postMessage:function(n){var r={data:n};setTimeout((function(){u(r)}))}}))],T=M,S=function(n,r,t){var e=r[0],o=r[1],a=r[2];I.set(e,t);var i=(0,m[o][0])(a);n.postMessage([e,o,a],i)},x=function(){T===M&&(T=[]);for(var n=O-T.length,r=0;n<0&&r<T.length;r+=1){var t=T[r],e=t[0];t[1]&&(e.terminate(),T.splice(r,1),n+=1,r-=1)}var a=T.reduce((function(n,r){return n+ +r[1]}),0),i=Math.min(n-a,A.length);for(r=0;r<i;r+=1){var u=E(new Worker(f));T.push(u)}0===T.length&&(T=M);for(var c=0,l=T;c<l.length;c++){e=(u=l[c])[0];if(u[1]){var v=A.shift();v&&(u[1]=!1,S.apply(void 0,o([e],v)))}}U()},U=w((function(){return T.some((function(n){return n[1]}))}))[0],D=function(n,r,t){var e=m.length;return m.push([n,r,t]),function(){for(var n=[],r=0;r<arguments.length;r++)n[r]=arguments[r];var t=n.length-1,o=n[t];n=g(n,0,t);var a=[b++,e,n];A.push([a,function(n,r){o(n,r),x()}]),x()}};0===v?(f=(null!==(a=document.currentScript)&&void 0!==a?a:(l=document.getElementsByTagName("script"),l[l.length-1])).src,c=function(n){window.Worker&&O!==n&&(O=n,x())}):1===v&&(onmessage=k(postMessage));var P,C,_=function(n){function r(t){var e=n.call(this,t)||this;return Object.setPrototypeOf(e,r.prototype),e}return function(n,r){if("function"!=typeof r&&null!==r)throw new TypeError("Class extends value "+String(r)+" is not a constructor or null");function t(){this.constructor=n}e(n,r),n.prototype=null===r?Object.create(r):(t.prototype=r.prototype,new t)}(r,n),r}(Error),F=function(n,r){return n[r]<<8|n[r+1]},j=function(n){return[n>>4,15&n]},q=function(n){var r=n.counts,t=n.symbols,e=[],o=t.length;if(r.reduce((function(n,r){return n+r}),0)!==o)throw new _("Invalid huffman table");for(var a=r.length-1;a>=0;a-=1){var i=r[a],u=g(t,o-i,o).concat(e);e=[];for(var f=0;f<u.length;f+=2)e.push(g(u,f,f+2));o-=i}if(e.length>1)throw new _("Invalid huffman table");return e[0]||[]},B=function(n){var r=n.length,t=0,e=[];do{if(r-t<17)throw new _("Invalid segment length");var o=j(n[t++]),a=o[0],i=o[1],u=g(n.subarray(t,t+16));t+=16;var f=u.reduce((function(n,r){return n+r}),0);if(f>r-t)throw new _("Invalid segment length");var c=g(n.subarray(t,t+f));t+=f;var l=q({counts:u,symbols:c});e.push({cls:a,id:i,tree:l})}while(t!==r);return{type:"DHT",tables:e}},z=function(n){return n?F:function(n,r){return n[r]}},N=function(r){var t=[],e=0,o=r.length;do{if(o-e<1)throw new _("invalid segment length");var a=j(r[e++]),i=a[0],u=a[1];if(u<0||u>3)throw new _("invalid quantization table identifier");if(i<0||i>1)throw new _("invalid quantization value size");var f=i+1;if(64*f>o-e)throw new _("invalid segment length");for(var c=new(i?Uint16Array:Uint8Array)(64),l=z(i),v=0;v<64;v+=1)c[n[v]]=l(r,v*f+e);t.push({id:u,values:c}),e+=64*f}while(e!==o);return{type:"DQT",tables:t}},Q=function(n){return String.fromCharCode.apply(null,n)},W=function(n){return 224<=n&&n<=239},H=(C=(P=r).length,function(n){var r=n.appType,t=n.data;return 0===r&&0===t[C]&&Q(t.subarray(0,C))===P}),J=function(n,r){var t={type:"APP",appType:n,data:r};return H(t)?L(r):t},L=function(n){var t={type:r,version:[n[5],n[6]],units:n[7],density:{x:F(n,8),y:F(n,10)}},e=n[12],o=n[13];return e>0&&o>0&&(t.thumbnail={x:e,y:o,data:n.subarray(14)}),t},R=function(n){return 192<=n&&n<=207&&196!==n&&200!==n&&204!==n},G=function(n,r){var t=r[0],e=F(r,1),o=F(r,3),a=r[5];if(r.length!==3*a+6)throw new _("Invalid segment length");for(var i=6,u=[],f=0;f<a;f+=1){var c=r[i++],l=j(r[i++]),v=l[0],s=l[1],h=r[i++];u.push({id:c,h:v,v:s,qId:h})}return{type:"SOF",frameType:n,precision:t,width:o,height:e,components:u}},K=function(n){var r;if(r=n,255!==(n=2===v&&Buffer.isBuffer(r)?new Uint8Array(r.buffer,r.byteOffset,r.length):r)[0]||216!==n[1])throw new _("Missing SOI marker");var e,o=[{type:"SOI"}],a=2,i=n.length;n:for(var u=a;u<i;u+=1){var f=n[u];if(255!==f){if(u===a)throw new _("Invalid marker");var c=++u;if(218===f){var l=F(n,u);u+=2;for(var s=n[u++],h=[],p=0;p<s;p+=1){var d=n[u++],g=j(n[u++]),y=g[0],w=g[1];h.push({id:d,dcId:y,acId:w})}for(var m=n[u++],b=n[u++],I=j(n[u++]),A=I[0],k=I[1];u<i;u+=1)if(255===(f=n[u])){if(0===(f=n[u+1])||208<=(e=f)&&e<=215)continue;a=u,o.push({type:t,components:h,specStart:m,specEnd:b,ah:A,al:k,data:n.subarray(c+l,a)});continue n}break}if(217===f)return o.push({type:"EOI"}),o;var E=F(n,u);if(E<2)throw new _("Invalid segment length");u=a=c+E;var O=n.subarray(c+2,a);if(219===f)o.push(N(O));else if(196===f)o.push(B(O));else if(254===f)o.push({type:"COM",text:Q(O)});else if(W(f))o.push(J(15&f,O));else{if(!R(f))throw new _("Unknown marker");o.push(G(15&f,O))}}}throw new _("Unexpected end of buffer")},V=1.3870398453221475,X=1.3065629648763766,Y=1.1758756024193588,Z=.7856949583871022,$=.541196100146197,nn=.275899379282943,rn=Math.SQRT2,tn=function(n,r){for(var t=0,e=0;t<8;t+=1){var o=n[e++],a=n[e++],i=n[e++],u=n[e++],f=n[e++],c=n[e++],l=n[e++],v=n[e++],s=o+f,h=o-f,p=$*i-X*l,d=X*i+$*l,g=nn*a-V*v,y=Y*c-Z*u,w=Z*c+Y*u,m=V*a+nn*v,b=g+y,I=y-g,A=m-w,k=w+m,E=(I+A)/rn,O=(A-I)/rn,M=s+d,T=h+p,S=h-p,x=s-d;r[t]=M+k,r[t+8]=T+O,r[t+16]=S+E,r[t+24]=x+b,r[t+32]=x-b,r[t+40]=S-E,r[t+48]=T-O,r[t+56]=M-k}},en=new Int16Array(64),on=new Float64Array(64),an=new Float64Array(64),un=function(n,r,t,e){for(var o=0;o<64;o+=1)en[o]=r[o]*n[o];tn(en,on),tn(on,an);for(o=0;o<64;o+=1)t[e++]=an[o]/8+128},fn=function(n,r,t,e){t[e]=r[0]*n[0]/8+128},cn=function(n){return 8===n?fn:un},ln=Math.max,vn=Math.ceil,sn=Math.round,hn=function(n,r){return[new Uint8ClampedArray(n*r*4),n,r]},pn=function(n,r,t,e,o,a,i){for(var u=new Uint32Array(3*n*(e/r)),f=0,c=o.length,l=8/r,v=0;v<t;v+=1)for(var s=0;s<c;s+=1)for(var h=o[s],p=h.h,d=h.v,g=a/p,y=i/d,w=0;w<d;w+=1)for(var m=0;m<p;m+=1)for(var b=0;b<l;b+=1)for(var I=0;I<l;I+=1){for(var A=0;A<y;A+=1)for(var k=0;k<g;k+=1){var E=((v*p+m)*l+I)*g+k;E<n&&(u[(E+((w*l+b)*y+A)*n)*c+s]=f)}f+=1}return u},dn=function(n,r,t){var e,o,a,i=r.length,u=0;return function(){for(var f=0;f<i;)e=n[r[f++]],o=n[r[f++]],a=n[r[f++]],t[u++]=e+1.402*a-179.456,t[u++]=e-.34414*o-.71414*a+135.45984,t[u++]=e+1.772*o-226.816,t[u++]=255}},gn=function(r,t){var e=function(n){var r,t=0,e=-1;return function(){if(e<0&&(r=n[t++],e=7,255===r&&0!==n[t++]))throw Error("Unexpected marker in compressed data");return r>>e--&1}}(r),o=function(n){for(var r=0,t=0;t<n;t+=1)r=(r<<1)+e();return r},a=function(n){for(var r;;){if("number"==typeof(r=n[e()]))return r;if(null==r)throw Error("Unexpected huffman code");n=r}};return function(r,e,i){t[0]=r+function(n){var r=a(n),t=o(r);return yn(t,r)}(e);for(var u=1;u<64;u+=1)t[u]=0;for(u=1;u<64;){var f=a(i),c=15&f,l=(240&f)>>4;if(0!==c){var v=o(c);t[n[u+=l]]=yn(v,c),u+=1}else 15===l?u+=16:0===l&&(u=64)}}},yn=function(n,r){return n<1<<r-1?n+(-1<<r)+1:n},wn=Array.isArray,mn=Math.max,bn=function(n){return function(n,r){for(var t=0,e=n;t<e.length;t++){var o=e[t];if(r(o))return o}}(n,(function(n){return"APP"===n.type||n.type===t})).data.buffer},In=function(n,r){!function(n){return 2!==v&&n instanceof Blob}(n)?r(null,n):function(n,r){var t=new FileReader;t.onload=function(){r(void 0,t.result)},t.onerror=r,t.readAsArrayBuffer(n)}(n,r)},An=D((function(n){return n}),(function(n){return K(new Uint8Array(n))}),(function(n){return[bn(n)]})),kn=D((function(n){var r=n[0];return[bn(r)]}),(function(n,r){var e,o=(void 0===r?{}:r).downScale,a=void 0===o?1:o,i=[[],[]],u=[],f=function(n){switch(n.type){case"DHT":for(var r=0,o=n.tables;r<o.length;r++){var f=o[r];i[f.cls][f.id]=f.tree}break;case"DQT":for(var c=0,l=n.tables;c<l.length;c++){f=l[c];u[f.id]=f}break;case"SOF":if(n.frameType<0||n.frameType>1||8!==n.precision)throw Error("Not 8-bit sequential");for(var v=[],s=0,h=n.components;s<h.length;s++){v[(M=h[s]).id]=M}e={components:v,width:n.width,height:n.height,imageData:hn(sn(n.width/a),sn(n.height/a))};break;case t:if(!e)throw Error("Missing frame");var p=e.components,d=e.width,g=e.height,y=e.imageData,w=y[0],m=y[1],b=n.components;if(!(b.length>1))throw Error("Not interleaved");for(var I=0,A=0,k=0,E=0,O=b;E<O.length;E++){var M=O[E],T=p[M.id],S=T.h,x=T.v;if(S<1||S>4||x<1||x>4)throw Error("Invalid sampling factor");I=ln(I,S),A=ln(A,x),k+=S*x}for(var U=8*A,D=vn(d/(8*I)),P=vn(g/U),C=i[0],_=i[1],F=new Int16Array(64),j=gn(n.data,F),q=b.length,B=new Int16Array(q),z=Math.pow(8/a,2),N=new Uint8ClampedArray(D*k*z),Q=cn(a),W=dn(N,pn(m,a,D,U,b.map((function(n){var r=n.id;return p[r]})),I,A),w),H=0;H<P;H+=1){for(var J=0,L=0;L<D;L+=1)for(var R=0;R<q;R+=1){M=b[R];for(var G=p[M.id],K=(S=G.h,x=G.v,G.qId),V=u[K].values,X=0;X<x;X+=1)for(var Y=0;Y<S;Y+=1)j(B[R],C[M.dcId],_[M.acId]),B[R]=F[0],Q(V,F,N,J),J+=z}W()}break;case"EOI":return"break-segmentLoop"}};n:for(var c=0,l=n;c<l.length;c++){switch(f(l[c])){case"break-segmentLoop":break n}}if(!e)throw Error("Missing frame");return e.imageData}),(function(n){return[n[0].buffer]})),En=0,On=w((function(){return En<mn(O,1)+1})),Mn=On[0],Tn=On[1],Sn=function(n){return function(){for(var r=[],t=0;t<arguments.length;t++)r[t]=arguments[t];En+=1,Mn();var e=r.length-1,o=r[e];r[e]=function(n,r){En-=1,Mn(),o(n,r)},n.apply(void 0,r)}},xn=function(n,r){var t,e,o=function(r){wn(n)?r(null,n):p(In,An)(n,r)};return{scale:function(t){return xn(n,r*t)},toJPEG:d(Sn(o)),toImageData:d(Sn(p(o,p((e={downScale:1/r},function(n,r){kn(n,e,r)}),(t=function(n){return y.apply(void 0,n)},function(){for(var n,r,e=[],o=0;o<arguments.length;o++)e[o]=arguments[o];var a=e.length-1;try{r=t.apply(void 0,g(e,0,a))}catch(r){n=r}e[a](n,r)})))))}},Un=function(n){return xn(n,1)};return Un.setWorkerCount=c,Un.waitIdle=Tn,Un.version="0.0.0",Un}));
