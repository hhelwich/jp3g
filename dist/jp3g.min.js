!function(n,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e((n="undefined"!=typeof globalThis?globalThis:n||self).jp3g={})}(this,(function(n){"use strict";var e=function(n,t){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(n,e){n.__proto__=e}||function(n,e){for(var t in e)Object.prototype.hasOwnProperty.call(e,t)&&(n[t]=e[t])})(n,t)};function t(n,e,t,r){return new(t||(t=Promise))((function(o,a){function i(n){try{f(r.next(n))}catch(n){a(n)}}function u(n){try{f(r.throw(n))}catch(n){a(n)}}function f(n){var e;n.done?o(n.value):(e=n.value,e instanceof t?e:new t((function(n){n(e)}))).then(i,u)}f((r=r.apply(n,e||[])).next())}))}function r(n,e){var t,r,o,a,i={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return a={next:u(0),throw:u(1),return:u(2)},"function"==typeof Symbol&&(a[Symbol.iterator]=function(){return this}),a;function u(a){return function(u){return function(a){if(t)throw new TypeError("Generator is already executing.");for(;i;)try{if(t=1,r&&(o=2&a[0]?r.return:a[0]?r.throw||((o=r.return)&&o.call(r),0):r.next)&&!(o=o.call(r,a[1])).done)return o;switch(r=0,o&&(a=[2&a[0],o.value]),a[0]){case 0:case 1:o=a;break;case 4:return i.label++,{value:a[1],done:!1};case 5:i.label++,r=a[1],a=[0];continue;case 7:a=i.ops.pop(),i.trys.pop();continue;default:if(!(o=i.trys,(o=o.length>0&&o[o.length-1])||6!==a[0]&&2!==a[0])){i=0;continue}if(3===a[0]&&(!o||a[1]>o[0]&&a[1]<o[3])){i.label=a[1];break}if(6===a[0]&&i.label<o[1]){i.label=o[1],o=a;break}if(o&&i.label<o[2]){i.label=o[2],i.ops.push(a);break}o[2]&&i.ops.pop(),i.trys.pop();continue}a=e.call(n,i)}catch(n){a=[6,n],r=0}finally{t=o=0}if(5&a[0])throw a[1];return{value:a[0]?a[1]:void 0,done:!0}}([a,u])}}}function o(){for(var n=0,e=0,t=arguments.length;e<t;e++)n+=arguments[e].length;var r=Array(n),o=0;for(e=0;e<t;e++)for(var a=arguments[e],i=0,u=a.length;i<u;i++,o++)r[o]=a[i];return r}var a,i,u="undefined"!=typeof window?0:"undefined"!=typeof self?1:2,f=[],c=0,s=new Map,l=[],h=function(n){return function(e){var o=e.data,a=o[0],i=o[1],u=o[2];return t(void 0,void 0,void 0,(function(){var e,t,o,c,s,l,h;return r(this,(function(r){switch(r.label){case 0:return r.trys.push([0,2,,3]),e=f[i],t=e[0],o=e[2],[4,t.apply(void 0,u)];case 1:return c=r.sent(),h=[a,c],s=o(c),n(h,s),[3,3];case 2:return l=r.sent(),h=[a,,l.message],n(h),[3,3];case 3:return[2]}}))}))}},v=function(n){var e=[n,!1];return n.onmessage=function(n){var t=n.data,r=t[0],o=t[1],a=t[2];e[1]=!1;var i=s.get(r),u=i[0],f=i[1];s.delete(r),a?f(Error(a)):u(o)},e},p=[v((i=h((function(n){var e={data:n};a.onmessage(e)})),a={postMessage:function(n){i({data:n})}}))],d=p,w=function(n,e,t){var r=e[0],o=e[1],a=e[2];s.set(r,t);var i=(0,f[o][1])(a);n.postMessage(e,i)},y=function(){for(var n=0,e=d;n<e.length;n++){var t=e[n];if(!t[1]){var r=l.shift();if(!r)return;t[1]=!0,w.apply(void 0,o([t[0]],r))}}},g=function(n,e,t){var r=f.length;return f.push([n,e,t]),function(){for(var n=[],e=0;e<arguments.length;e++)n[e]=arguments[e];var t=new Promise((function(e,t){var o=[e,t],a=[c++,r,n];l.push([a,o]),y()}));return t.then(y,y),t}};1===u&&(onmessage=h(postMessage));var m,b=function(n){function t(e){var r=n.call(this,e)||this;return Object.setPrototypeOf(r,t.prototype),r}return function(n,t){function r(){this.constructor=n}e(n,t),n.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)}(t,n),t}(Error),x=function(n,e){return n[e]<<8|n[e+1]},k=function(n){return[n>>4,15&n]},O=function(n){var e=n.counts,t=n.symbols,r=[],o=t.length;if(e.reduce((function(n,e){return n+e}),0)!==o)throw new b("Invalid huffman table");for(var a=e.length-1;a>=0;a-=1){var i=e[a],u=t.slice(o-i,o).concat(r);r=[];for(var f=0;f<u.length;f+=2)r.push(u.slice(f,f+2));o-=i}if(r.length>1)throw new b("Invalid huffman table");return r[0]||[]},T=function(n){var e=n.length,t=0,r=[];do{if(e-t<17)throw new b("Invalid segment length");var o=k(n[t++]),a=o[0],i=o[1],u=Array.from(n.subarray(t,t+16));t+=16;var f=u.reduce((function(n,e){return n+e}),0);if(f>e-t)throw new b("Invalid segment length");var c=Array.from(n.subarray(t,t+f));t+=f;var s=O({counts:u,symbols:c});r.push({cls:a,id:i,tree:s})}while(t!==e);return{type:"DHT",tables:r}},I=new Uint8Array([0,1,8,16,9,2,3,10,17,24,32,25,18,11,4,5,12,19,26,33,40,48,41,34,27,20,13,6,7,14,21,28,35,42,49,56,57,50,43,36,29,22,15,23,30,37,44,51,58,59,52,45,38,31,39,46,53,60,61,54,47,55,62,63]),S=function(n){return 1===n?function(n,e){return n[e]}:x},M=function(n){var e=[],t=0,r=n.length;do{if(r-t<1)throw new b("invalid segment length");var o=k(n[t++]),a=o[0],i=o[1];if(i<0||i>3)throw new b("invalid quantization table identifier");if(a<0||a>1)throw new b("invalid quantization value size");var u=a+1;if(64*u>r-t)throw new b("invalid segment length");for(var f=Array(64),c=S(u),s=0;s<64;s+=1)f[I[s]]=c(n,s*u+t);e.push({id:i,bytes:u,values:f}),t+=64*u}while(t!==r);return{type:"DQT",tables:e}},A=function(n){return 224<=n&&n<=239},E=function(n){return 192<=n&&n<=207&&196!==n&&200!==n&&204!==n},P=function(n,e){return{type:"APP",appType:n,data:e}},_=function(n,e){var t=e[0],r=x(e,1),o=x(e,3),a=e[5];if(e.length!==3*a+6)throw new b("Invalid segment length");for(var i=6,u=[],f=0;f<a;f+=1){var c=e[i++],s=k(e[i++]),l=s[0],h=s[1],v=e[i++];u.push({id:c,h:l,v:h,qId:v})}return{type:"SOF",frameType:n,precision:t,width:o,height:r,components:u}},D=function(n){if(255!==n[0]||216!==n[1])throw new b("Missing SOI marker");var e,t,r=[{type:"SOI"}],o=2,a=n.length;n:for(var i=o;i<a;i+=1){var u=n[i];if(255!==u){if(i===o)throw new b("Invalid marker");var f=++i;if(218===u){var c=x(n,i);i+=2;for(var s=n[i++],l=[],h=0;h<s;h+=1){var v=n[i++],p=k(n[i++]),d=p[0],w=p[1];l.push({id:v,dcTbl:d,acTbl:w})}for(var y=n[i++],g=n[i++],m=k(n[i++]),O=m[0],I=m[1];i<a;i+=1)if(255===(u=n[i])){if(0===(u=n[i+1])||208<=(t=u)&&t<=215)continue;o=i,r.push({type:"SOS",components:l,specStart:y,specEnd:g,ah:O,al:I,data:n.subarray(f+c,o)});continue n}break}if(217===u)return r.push({type:"EOI"}),r;var S=x(n,i);if(S<2)throw new b("Invalid segment length");i=o=f+S;var D=n.subarray(f+2,o);if(219===u)r.push(M(D));else if(196===u)r.push(T(D));else if(254===u)r.push((e=D,{type:"COM",text:String.fromCharCode.apply(null,e)}));else if(A(u))r.push(P(15&u,D));else{if(!E(u))throw new b("Unknown marker");r.push(_(15&u,D))}}}throw new b("Unexpected end of buffer")},U=function(n,e,t){for(var r=0;r<64;r+=1)t[r]=e[r]*n[r]},j=1.3870398453221475,C=1.3065629648763766,q=1.1758756024193588,z=.7856949583871022,H=.541196100146197,N=.275899379282943,Q=[],B=Math.SQRT2,F=function(n){return function(e){n(e,Q);var t=[];n(Q,t);for(var r=0;r<64;r+=1)t[r]/=8;return t}}((function(n,e){for(var t=0,r=0;t<8;t+=1){var o=n[r++],a=n[r++],i=n[r++],u=n[r++],f=n[r++],c=n[r++],s=n[r++],l=n[r++],h=o+f,v=o-f,p=H*i-C*s,d=C*i+H*s,w=N*a-j*l,y=q*c-z*u,g=z*c+q*u,m=j*a+N*l,b=w+y,x=y-w,k=m-g,O=g+m,T=(x+k)/B,I=(k-x)/B,S=h+d,M=v+p,A=v-p,E=h-d;e[t]=S+O,e[t+8]=M+I,e[t+16]=A+T,e[t+24]=E+b,e[t+32]=E-b,e[t+40]=A-T,e[t+48]=M-I,e[t+56]=S-O}})),L=(m=128,function(n){for(var e=[],t=0;t<64;t+=1)e[t]=n[t]+m;return e}),G=function(n){var e=n[0],t=n[1],r=n[2];return[e+1.402*r-179.456,e-.34414*t-.71414*r+135.45984,e+1.772*t-226.816]},R=function(n){var e,t=0,r=-1,o=function(){if(r<0&&(e=n[t++],r=7,255===e&&0!==n[t++]))throw Error("Unexpected marker in compressed data");return e>>r--&1},a=function(n){for(var e=0,t=0;t<n;t+=1)e=(e<<1)+o();return e},i=function(n){for(var e;;){if("number"==typeof(e=n[o()]))return e;if(null==e)throw Error("Unexpected huffman code");n=e}},u=function(n){var e=i(n),t=a(e);return W(t,e)},f=0,c=function(n){return f+=u(n)};return{nextBit:o,nextHuffmanByte:i,nextDcDiff:u,nextDc:c,getCoeff:function(n,e){f=0;var t=[];t[0]=c(n);for(var r=1;r<64;r+=1)t[r]=0;for(r=1;r<64;){var o=i(e),u=15&o,s=(240&o)>>4;if(0!==u){var l=a(u);t[I[r+=s]]=W(l,u),r+=1}else 15===s?r+=16:0===s&&(r=64)}return t}}},W=function(n,e){return n<1<<e-1?n+(-1<<e)+1:n},J=function(n){return[n.data.buffer]},K=function(n){return J(n.find((function(n){return"APP"===n.type||"SOS"===n.type})))},V=g((function(n){return t(void 0,void 0,void 0,(function(){return r(this,(function(e){return[2,D(new Uint8Array(n))]}))}))}),(function(n){return n}),K),X=g((function(n){return t(void 0,void 0,void 0,(function(){var e,t,o,a;return r(this,(function(r){return e=function(n){var e=[[],[]],t=[],r=[],o={data:new Uint8ClampedArray,width:0,height:0},a=[],i=function(n){switch(n.type){case"DHT":for(var i=0,u=n.tables;i<u.length;i++){var f=u[i];e[f.cls][f.id]=f.tree}break;case"DQT":for(var c=0,s=n.tables;c<s.length;c++)f=s[c],t[f.id]=f;break;case"SOF":if(n.frameType<0||n.frameType>1||8!==n.precision)throw new Error("Not 8-bit sequential");var l=n.components.length>1;if(0===n.components.length)throw new b("No components found");if(!l)throw new Error("Not interleaved");var h=Math.max.apply(Math,n.components.map((function(n){return n.h}))),v=Math.max.apply(Math,n.components.map((function(n){return n.v})));r=[];for(var p=0,d=n.components;p<d.length;p++){var w=d[p];r[w.id]=w}n.components.map((function(n){var e=n.h,t=n.v;return{x:8*h/e,y:8*v/t}})),n.width,n.height,o={data:new Uint8ClampedArray(n.width*n.height*4),width:n.width,height:n.height};break;case"SOS":for(var y=e[0],g=e[1],m=R(n.data).getCoeff,x=0,k=n.components;x<k.length;x++){w=k[x];for(var O=r[w.id],T=O.v,I=O.h,S=O.qId,M=t[S],A=0;A<T;A+=1)for(var E=0;E<I;E+=1){var P=m(y[w.dcTbl],g[w.acTbl]),_=[];U(M.values,P,_);var D=F(_),j=L(D);a[w.id-1]=j}}for(A=0;A<64;A+=1){var C=G([a[0][A],a[1][A],a[2][A]]),q=C[0],z=C[1],H=C[2];o.data[4*A+0]=q,o.data[4*A+1]=z,o.data[4*A+2]=H,o.data[4*A+3]=255}break;case"EOI":return"break-segmentLoop"}};n:for(var u=0,f=n;u<f.length;u++)switch(i(f[u])){case"break-segmentLoop":break n}return o}(n),t=e.data,o=e.width,a=e.height,[2,new ImageData(t,o,a)]}))}))}),(function(n){var e=n[0];return K(e)}),J);n.decode=V,n.decodeImage=X,n.setWorkers=function(){for(var n=[],e=0;e<arguments.length;e++)n[e]=arguments[e];d=n.length>0?n.map(v):p,y()},n.version="0.0.0",Object.defineProperty(n,"__esModule",{value:!0})}));
